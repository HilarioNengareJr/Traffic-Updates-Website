var searchBoxInstance,startCornerLngLat,endCornerLngLat,mousePressed,drawBoundingBoxButtonPressed,apiKey="4UstADW0Kh9gdQkRwCkAGTABGVGTgyTl",centerCoords=[33.363878,35.17465],initialZoom=10,map=tt.map({key:apiKey,container:"map",center:centerCoords,zoom:initialZoom}),layerFillID=(map.setStyle("tomtom://vector/1/satellite"),"layerFillID"),layerOutlineID="layerOutlineID",sourceID="sourceID",styleBase="tomtom://vector/1/",styleS1="s1",styleRelative="relative",refreshTimeInMillis=3e4,popupHideDelayInMilis=4e3,incidentListContainer=document.getElementById("incident-list"),trafficFlowTilesToggle=document.getElementById("flow-toggle"),trafficIncidentsTier=new tt.TrafficIncidentTier({key:apiKey,incidentDetails:{style:styleS1},incidentTiles:{style:styleBase+styleS1},refresh:refreshTimeInMillis}),trafficFlowTilesTier=new tt.TrafficFlowTilesTier({key:apiKey,style:styleBase+styleRelative,refresh:refreshTimeInMillis}),commonSearchBoxOptions={key:apiKey,center:map.getCenter()};function toggleTrafficFlowTilesTier(){trafficFlowTilesToggle.checked?map.addTier(trafficFlowTilesTier):map.removeTier(trafficFlowTilesTier.getId())}function showTrafficIncidentsTier(){document.getElementById("incidents-toggle").checked=!0,map.addTier(trafficIncidentsTier)}function hideTrafficIncidentsTier(){document.getElementById("incidents-toggle").checked=!1,map.removeTier(trafficIncidentsTier.getId()),clearIncidentList(),removeBoundingBox()}function toggleTrafficIncidentsTier(){(document.getElementById("incidents-toggle").checked?showTrafficIncidentsTier:hideTrafficIncidentsTier)()}function updateSearchBoxOptions(){var e=Object.assign(commonSearchBoxOptions,{center:map.getCenter()});searchBoxInstance.updateOptions({minNumberOfCharacters:0,searchOptions:e,autocompleteOptions:e})}function onSearchBoxResult(e){map.flyTo({center:e.data.result.position,speed:3})}function enableBoundingBoxDraw(){showInfoPopup("Click and drag to draw a bounding box"),drawBoundingBoxButtonPressed=!0,removeBoundingBox(),clearIncidentList()}function getPopupWrapper(){return document.getElementById("popup-wrapper")}function showPopup(e){e.style.opacity="0.9"}function showInfoPopup(e){var t=getPopupWrapper();t.innerHTML=getPopupInnerHTML("popup-info",e),showPopup(t)}function showErrorPopup(e){var t=getPopupWrapper();t.innerHTML=getPopupInnerHTML("popup-error",e),showPopup(t)}function hidePopup(e){var t=getPopupWrapper();0==e?t.style.opacity="0":setTimeout(function(){t.style.opacity="0"},e)}function getPopupInnerHTML(e,t){return`<div class="container ${e} popup"> <div class="row"> <div class="col py-2"> <div class="row align-items-center pt-1"> <div class="col-sm-1"> <img src="img/error-symbol.png" alt=""/> </div><div id="popup-message" class="col"> ${t} </div></div></div></div></div>`}function removeBoundingBox(){map.getSource(sourceID)&&(map.removeLayer(layerFillID),map.removeLayer(layerOutlineID),map.removeSource(sourceID))}function onMouseDown(e){drawBoundingBoxButtonPressed&&(e.preventDefault(),mousePressed=!0,startCornerLngLat=e.lngLat,removeBoundingBox(),map.addSource(sourceID,getPolygonSource(startCornerLngLat,startCornerLngLat)),map.addLayer({id:layerFillID,type:"fill",source:sourceID,layout:{},paint:{"fill-color":"#666","fill-opacity":.1}}),map.addLayer({id:layerOutlineID,type:"line",source:sourceID,layout:{},paint:{"line-width":4,"line-color":"#424242","line-dasharray":[2,1],"line-blur":.5}}))}function onMouseMove(e){mousePressed&&(endCornerLngLat=e.lngLat,updateRectangleData(startCornerLngLat,endCornerLngLat))}function onMouseUp(e){mousePressed=!1,hidePopup(0),drawBoundingBoxButtonPressed&&(endCornerLngLat=e.lngLat,bothLngLatAreDifferent(startCornerLngLat,endCornerLngLat)?(updateRectangleData(startCornerLngLat,endCornerLngLat),clearIncidentList(),displayTrafficIncidents(getLngLatBoundsForIncidentDetailsCall(startCornerLngLat,endCornerLngLat)),showTrafficIncidentsTier()):(showErrorPopup("Try to select bigger bounding box."),hidePopup(popupHideDelayInMilis))),drawBoundingBoxButtonPressed=!1}function bothLngLatAreDifferent(e,t){return e.lat!==t.lat&&e.lng!==t.lng}function updateRectangleData(e,t){map.getSource(sourceID).setData(getPolygonSourceData(e,t))}function getLngLatBoundsForIncidentDetailsCall(e,t){var n=new tt.LngLat((e.lng<t.lng?e:t).lng,(e.lat<t.lat?e:t).lat),e=new tt.LngLat((e.lng>t.lng?e:t).lng,(t.lat<e.lat?e:t).lat);return tt.LngLatBounds.convert([n.toArray(),e.toArray()])}function getPolygonSourceData(e,t){return{type:"Feature",geometry:{type:"Polygon",coordinates:[[[e.lng,e.lat],[e.lng,t.lat],[t.lng,t.lat],[t.lng,e.lat],[e.lng,e.lat]]]}}}function getPolygonSource(e,t){return{type:"geojson",data:getPolygonSourceData(e,t)}}function clearIncidentList(){incidentListContainer.innerHTML=""}function isCluster(e){return e.id.includes("CLUSTER")}function displayTrafficIncidents(e){var n=["danger","accident","fog","danger","rain","ice","incident","laneclosed","roadclosed","roadworks","wind","flooding","detour",""],o=["unknown","minor","moderate","major","undefined"];tt.services.incidentDetails({key:apiKey,boundingBox:e,style:styleS1,zoomLevel:parseInt(map.getZoom())}).go().then(function(e){0===e.tm.poi.length?(showErrorPopup("There are no traffic incidents in this area."),hidePopup(popupHideDelayInMilis)):e.tm.poi.forEach(function(e){var t=createButtonItem(e.p);isCluster(e)?t.innerHTML=getButtonClusterContent(e.id,e.cs,o[e.ty]):t.innerHTML=getButtonIncidentContent(e.d.toUpperCase(),n[e.ic],o[e.ty],e.f,e.t),incidentListContainer.appendChild(t)})})}function createButtonItem(e){var t=document.createElement("button");return t.setAttribute("type","button"),t.classList.add("list-group-item","list-group-item-action","incidendDetailsListItemButton"),t.addEventListener("click",function(){map.flyTo({center:e})},!1),t}function getButtonIncidentContent(e,t,n,o,i){return`<div class="row align-items-center pb-2"> <div class="col-sm-2"> <div class="tt-traffic-icon"> <div class="tt-icon-circle-${n} traffic-icon"> <div class="tt-icon-${t}"></div></div></div></div><div class="col label pl-0"> ${e} </div></div><div class="row"> <div class="col-sm-2"><label class="label">From: </label></div><div class="col"><label class="incident-details-list-normal-text">${o}</label> </div></div><div class="row"> <div class="col-sm-2"><label class="label">To: </label></div><div class="col"><label class="incident-details-list-normal-text">${i}</label></div></div>`}function getButtonClusterContent(e,t,n){return`<div class="row align-items-center pb-2"> <div class="col-sm-2"> <div class="tt-traffic-icon"> <div class="tt-icon-circle-${n} traffic-icon"> <div id="cluster-icon" class="tt-icon-number">${t}</div></div></div></div><div class="col label pl-0"> ${e} </div></div>`}function initApplication(){(searchBoxInstance=new tt.plugins.SearchBox(tt.services,{minNumberOfCharacters:0,labels:{placeholder:"Search"},noResultsMessage:"No results found.",searchOptions:commonSearchBoxOptions,autocompleteOptions:commonSearchBoxOptions})).on("tomtom.searchbox.resultselected",onSearchBoxResult),document.getElementById("search-panel").append(searchBoxInstance.getSearchBoxHTML()),trafficFlowTilesToggle.addEventListener("change",toggleTrafficFlowTilesTier),document.getElementById("incidents-toggle").addEventListener("change",toggleTrafficIncidentsTier),document.getElementById("bounding-box-button").addEventListener("click",enableBoundingBoxDraw),map.on("mousedown",onMouseDown),map.on("mouseup",onMouseUp),map.on("mousemove",onMouseMove),map.on("moveend",updateSearchBoxOptions)}initApplication();